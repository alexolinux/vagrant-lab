# -*- mode: ruby -*-

Vagrant.configure("2") do |config|

  # Vagrant Addition Guest Plugin Configurations  --------------------
  # https://github.com/dotless-de/vagrant-vbguest --------------------
  # set auto_update to false, if you do NOT want to check the correct 
  # Additions version when booting this machine
  config.vbguest.auto_update = false  
  # Do NOT download the iso file from a webserver
  config.vbguest.no_remote = true

  # Enable Environment Plugin (optional)
  # Some versions of the vagrant-env plugin (or its dotenv dependency) can
  # trigger an early fatal error with newer Ruby/Vagrant combinations
  # (e.g. undefined method `exists?'). Guard the call so the Vagrantfile
  # can still load and use ENV variables directly when the plugin fails.
  
  # Manually load .env file
  if File.exist?('.env')
    File.readlines('.env').each do |line|
      line.strip!
      if line.length > 0 && !line.start_with?('#')
        key, value = line.split('=', 2)
        ENV[key] = value.gsub(/"/, '') if key && value
      end
    end
  end
  
  # Vagrant Box Distribution
  distro = ENV['DIST']
  version = ENV['VER']

  config.vm.box = "#{distro}/#{version}"

  # Variables for VM Settings
  memory = "#{memory}"
  cpu = "#{cpu}"

  # Variables Environment
  interface = ENV['IFACE']
  network = ENV['NETWORK']
  base_ip = ENV['BASEIP']
  netmask = ENV['NETMASK']
  gateway = ENV['GATEWAY']
  prefix = ENV['PREFIX']
  memory = ENV['MEMORY']
  cpu = ENV['CPU']
  group = ENV['GROUP']

  # User Variables
  username = ENV['USER']
  home = ENV['HOME']
  pubkey = ENV['PUBKEY']

  # Validate required environment variables (helpful when vagrant-env/dotenv fails)
  required_envs = %w[DIST VER IFACE NETWORK BASEIP NETMASK GATEWAY PREFIX MEMORY CPU GROUP USER HOME PUBKEY]
  missing = required_envs.select { |k| ENV[k].nil? || ENV[k].to_s.strip == "" }
  if !missing.empty?
    abort <<~MSG
      Missing required environment variables: #{missing.join(', ')}

      The Vagrantfile expects these variables to be set (normally via a .env file
      loaded by the vagrant-env plugin). The plugin failed to enable above, so
      please either:
        1) Export the variables in your shell (e.g. export BASEIP=192.168.56.100 ...), or
        2) Create a .env file and fix or update the vagrant-env/dotenv plugin, or
        3) Edit the Vagrantfile to add defaults for your environment.

      Aborting to avoid an unclear error (like `undefined method 'split'`).
    MSG
  end

  # Number of VMs Lab to create
  num_vms = 1

  # Loop through the count index
  (1..num_vms).each do |i|
    ip_parts = base_ip.split('.')
    ip_parts[3] = (ip_parts[3].to_i + i).to_s
    ip = ip_parts.join('.')
    
    config.vm.define "#{prefix}#{i}" do |vm|
      vm.vm.hostname = "#{prefix}#{i}"
      vm.vm.network "public_network", bridge: "#{interface}", ip: "#{ip}", netmask: "#{netmask}"
    
      vm.vm.provider "virtualbox" do |vm|
        # VM System Resources
        vm.customize ["modifyvm", :id, "--vram", "16", "--groups", "/#{group}", "--audio", "none", "--graphicscontroller", "vmsvga"]
        vm.memory = "#{memory}"
        vm.cpus = "#{cpu}"
      end

      # Create Linux "Sudo" User
      vm.vm.provision "shell", inline: <<-SHELL        
        useradd -m -s /bin/bash -G vagrant "#{username}"
        echo "#{username}     ALL=(ALL)     NOPASSWD: ALL" | sudo tee -a /etc/sudoers.d/vagrant
        mkdir -p "/home/#{username}/.ssh"
        chmod 700 "/home/#{username}/.ssh"
        echo "#{pubkey}" | tee "/home/#{username}/.ssh/authorized_keys"
        chmod 600 "/home/#{username}/.ssh/authorized_keys"
        chown -R "#{username}:#{username}" "/home/#{username}/.ssh"
      SHELL

      # Adding Public DNS Resolvers
      vm.vm.provision "shell", inline: <<-SHELL        
        echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
        echo "nameserver 208.67.222.222" | sudo tee -a /etc/resolv.conf
        echo "nameserver 9.9.9.9" | sudo tee -a /etc/resolv.conf
      SHELL

      # Adding Bridge Route Gateway
      vm.vm.provision "shell", run: "always", inline:
        #"ip route add default via #{gateway} || true"
        "ip route add #{network} via #{gateway} || true"

      # In case you want to install additional repositories, installations, etc... Uncomment the line below
      # Vagrant VM Provisioning

      #vm.vm.provision "shell", path: "scripts/repo.sh"
      #vm.vm.provision "shell", path: "scripts/provisioner.sh"

      # Virtualbox Sync Folders
      vm.vm.synced_folder '.', '/vagrant', disabled: true
      
      # Uncomment the following line if you want to use synced_folder between Host x VMs (Edit  mountpoints)
      #vm.vm.synced_folder "#{home}/Public", "/sharing", "automount": true, "SharedFoldersEnableSymlinksCreate": true
    end
  end
end
